# =============================================================================
# NETWORK POLICIES FOR ZERO TRUST MICRO-SEGMENTATION
# Principle: Deny by default, allow only what's explicitly needed
# =============================================================================

# =============================================================================
# HR PORTAL NAMESPACE - PRIVATE, HR STAFF ONLY
# =============================================================================

---
# Default Deny All Traffic in HR Portal Namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: hr-portal
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
# Allow HR Frontend to Backend (internal communication only)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hr-frontend-to-backend
  namespace: hr-portal
spec:
  podSelector:
    matchLabels:
      app: hr-portal-backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: hr-portal-frontend
    ports:
    - protocol: TCP
      port: 3000
---
# Allow HR Backend to AWS Services (via VPC Endpoints only - no internet)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hr-backend-to-aws
  namespace: hr-portal
spec:
  podSelector:
    matchLabels:
      app: hr-portal-backend
  policyTypes:
  - Egress
  egress:
  # Allow to VPC CIDR (VPC Endpoints)
  - to:
    - ipBlock:
        cidr: 10.0.0.0/8
    ports:
    - protocol: TCP
      port: 443
  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
  # Allow to workspaces namespace (for provisioning)
  - to:
    - namespaceSelector:
        matchLabels:
          name: workspaces
    ports:
    - protocol: TCP
      port: 8080
---
# Allow Ingress to Frontend - ONLY from internal ALB (HR users authenticated via Cognito)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-frontend
  namespace: hr-portal
spec:
  podSelector:
    matchLabels:
      app: hr-portal-frontend
  policyTypes:
  - Ingress
  ingress:
  # Only allow traffic from internal ALB (VPC CIDR)
  - from:
    - ipBlock:
        cidr: 10.0.0.0/8
    ports:
    - protocol: TCP
      port: 8080
---
# Allow Frontend Egress (only to backend - no external access)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hr-frontend-egress
  namespace: hr-portal
spec:
  podSelector:
    matchLabels:
      app: hr-portal-frontend
  policyTypes:
  - Egress
  egress:
  # Only allow traffic to backend
  - to:
    - podSelector:
        matchLabels:
          app: hr-portal-backend
    ports:
    - protocol: TCP
      port: 3000
  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

# =============================================================================
# WORKSPACES NAMESPACE - PRIVATE, EMPLOYEE-ONLY ACCESS
# Each workspace is isolated and only accessible by its owner
# =============================================================================

---
# Default Deny All in Workspaces Namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: workspaces
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
# Allow Ingress to Workspaces - ONLY from internal ALB (authenticated employees)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-workspaces
  namespace: workspaces
spec:
  podSelector:
    matchLabels:
      app: workspace
  policyTypes:
  - Ingress
  ingress:
  # Only allow from internal ALB (VPC CIDR - authenticated via Cognito)
  - from:
    - ipBlock:
        cidr: 10.0.0.0/8
    ports:
    - protocol: TCP
      port: 8080
---
# Allow Workspaces Egress - Limited to VPC only (via VPC Endpoints)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: workspace-egress
  namespace: workspaces
spec:
  podSelector:
    matchLabels:
      app: workspace
  policyTypes:
  - Egress
  egress:
  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
  # Allow HTTPS to VPC CIDR only (VPC Endpoints for AWS services)
  - to:
    - ipBlock:
        cidr: 10.0.0.0/8
    ports:
    - protocol: TCP
      port: 443
  # Allow HTTP to VPC CIDR only (for internal services)
  - to:
    - ipBlock:
        cidr: 10.0.0.0/8
    ports:
    - protocol: TCP
      port: 80
---
# CRITICAL: Isolate Workspaces from Each Other
# Each workspace can ONLY be accessed by its owner, not other employees
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: isolate-workspaces-strict
  namespace: workspaces
spec:
  podSelector:
    matchLabels:
      app: workspace
  policyTypes:
  - Ingress
  ingress:
  # Block all pod-to-pod communication within workspaces namespace
  # Each workspace is isolated - no lateral movement possible
  - from:
    - ipBlock:
        cidr: 10.0.0.0/8
        except:
        # Exclude all private subnet CIDRs (pod network)
        - 10.0.48.0/20
        - 10.0.64.0/20
        - 10.0.80.0/20
    ports:
    - protocol: TCP
      port: 8080
---
# Allow workspace-router to reach workspaces
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-router-to-workspaces
  namespace: workspaces
spec:
  podSelector:
    matchLabels:
      app: workspace
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: workspace-router
    ports:
    - protocol: TCP
      port: 8080
---
# Workspace Router Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: workspace-router-policy
  namespace: workspaces
spec:
  podSelector:
    matchLabels:
      app: workspace-router
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Only from internal ALB
  - from:
    - ipBlock:
        cidr: 10.0.0.0/8
    ports:
    - protocol: TCP
      port: 8080
  egress:
  # To workspace pods only
  - to:
    - podSelector:
        matchLabels:
          app: workspace
    ports:
    - protocol: TCP
      port: 8080
  # DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

# =============================================================================
# KUBE-SYSTEM NAMESPACE PROTECTION
# =============================================================================

---
# Protect CoreDNS - only allow DNS queries
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: coredns-policy
  namespace: kube-system
spec:
  podSelector:
    matchLabels:
      k8s-app: kube-dns
  policyTypes:
  - Ingress
  ingress:
  # Allow DNS from all namespaces
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
