name: Fix and Deploy Frontend

on:
  workflow_dispatch:

env:
  AWS_REGION: eu-west-1

jobs:
  rebuild-frontend:
    name: Rebuild and Deploy Frontend
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::920120424621:role/githubrepo
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get AWS Account ID
        id: account
        run: echo "account_id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT

      - name: Build and push frontend image
        env:
          ECR_REGISTRY: ${{ steps.account.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building frontend with fixed nginx config..."
          cd applications/hr-portal/frontend
          docker build -t hr-portal-frontend .
          docker tag hr-portal-frontend:latest $ECR_REGISTRY/hr-portal-frontend:$IMAGE_TAG
          docker tag hr-portal-frontend:latest $ECR_REGISTRY/hr-portal-frontend:latest
          docker push $ECR_REGISTRY/hr-portal-frontend:$IMAGE_TAG
          docker push $ECR_REGISTRY/hr-portal-frontend:latest

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.28.4

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name innovatech-employee-lifecycle

      - name: Restart frontend deployment
        run: |
          echo "Restarting frontend deployment to use new image..."
          kubectl rollout restart deployment/hr-portal-frontend -n hr-portal
          
          echo "Waiting for rollout to complete..."
          kubectl rollout status deployment/hr-portal-frontend -n hr-portal --timeout=5m

      - name: Check pod status
        run: |
          echo "=== Frontend Pods Status ==="
          kubectl get pods -n hr-portal -l app=hr-portal-frontend
          echo ""
          echo "=== Recent Pod Events ==="
          kubectl get events -n hr-portal --field-selector involvedObject.kind=Pod --sort-by='.lastTimestamp' | tail -20

      - name: Get pod logs
        continue-on-error: true
        run: |
          echo "=== Frontend Pod Logs ==="
          kubectl logs -n hr-portal -l app=hr-portal-frontend --tail=30

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "           DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo ""
          POD_STATUS=$(kubectl get pods -n hr-portal -l app=hr-portal-frontend -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "Unknown")
          READY_COUNT=$(kubectl get deployment hr-portal-frontend -n hr-portal -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
          
          echo "Frontend Status: $POD_STATUS"
          echo "Ready Pods: $READY_COUNT/2"
          echo ""
          
          if [ "$READY_COUNT" == "2" ]; then
            echo "✅ Frontend is now running successfully!"
          else
            echo "⚠️ Frontend deployment may still be starting. Check logs above."
          fi
