name: Fix Ingress Host

on:
  workflow_dispatch:

jobs:
  fix-ingress:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::920120424621:role/innovatech-github-actions-role
          aws-region: eu-west-1
          
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name innovatech-employee-lifecycle --region eu-west-1
          
      - name: Delete existing Ingress
        run: |
          echo "=== DELETING EXISTING INGRESS ==="
          kubectl delete ingress hr-portal -n hr-portal || echo "No existing ingress found"
          
      - name: Wait for deletion
        run: |
          echo "Waiting for Ingress deletion..."
          sleep 10
          
      - name: Apply new Ingress
        run: |
          echo "=== APPLYING NEW INGRESS ==="
          kubectl apply -f kubernetes/hr-portal.yaml
          
      - name: Wait for Ingress to be ready
        run: |
          echo "=== WAITING FOR INGRESS ADDRESS ==="
          for i in {1..30}; do
            ADDRESS=$(kubectl get ingress hr-portal -n hr-portal -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
            if [ ! -z "$ADDRESS" ]; then
              echo "âœ… Ingress ADDRESS: $ADDRESS"
              break
            fi
            echo "Waiting for ADDRESS... (attempt $i/30)"
            sleep 10
          done
          
      - name: Show Ingress details
        run: |
          echo "=== INGRESS DETAILS ==="
          kubectl get ingress -n hr-portal
          kubectl describe ingress hr-portal -n hr-portal
          
      - name: Check ALB Listener Rules
        run: |
          echo "=== CHECKING ALB LISTENER RULES ==="
          echo "Waiting 30 seconds for AWS ALB to update..."
          sleep 30
          
          LB_DNS=$(kubectl get ingress hr-portal -n hr-portal -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "LoadBalancer DNS: $LB_DNS"
          
          # Get the load balancer ARN
          LB_ARN=$(aws elbv2 describe-load-balancers --query "LoadBalancers[?contains(DNSName, 'k8s-hrportal')].LoadBalancerArn" --output text)
          echo "LoadBalancer ARN: $LB_ARN"
          
          # Get listener ARN
          LISTENER_ARN=$(aws elbv2 describe-listeners --load-balancer-arn $LB_ARN --query "Listeners[0].ListenerArn" --output text)
          echo "Listener ARN: $LISTENER_ARN"
          
          # Show listener rules
          echo "=== LISTENER RULES ==="
          aws elbv2 describe-rules --listener-arn $LISTENER_ARN --query "Rules[*].{Priority:Priority,Conditions:Conditions,Actions:Actions}" --output json
          
      - name: Test endpoints
        run: |
          echo "=== TESTING ENDPOINTS ==="
          LB_DNS=$(kubectl get ingress hr-portal -n hr-portal -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          
          echo "Testing root path (frontend)..."
          curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://$LB_DNS/ || echo "Request failed"
          
          echo ""
          echo "Testing /api/employees (backend)..."
          curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://$LB_DNS/api/employees || echo "Request failed"
          
          echo ""
          echo "Testing /api/health (backend)..."
          curl -s http://$LB_DNS/api/health || echo "Request failed"
